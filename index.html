<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body{
      font-family: Arial;
      background:#eef2f7;
      padding:20px;
      max-width:600px;
      margin:auto;
    }

    .card{
      background:white;
      padding:22px;
      border-radius:16px;
      box-shadow:0 10px 25px rgba(0,0,0,0.08);
    }

    h2{
      margin:0 0 15px 0;
      font-size:22px;
    }

    label{
      display:block;
      margin-top:16px;
      font-weight:600;
      font-size:14px;
    }

    input,select,textarea{
      width:100%;
      padding:14px;
      margin-top:6px;
      border-radius:12px;
      border:1px solid #d1d5db;
      font-size:16px;
      box-sizing:border-box;
    }

    textarea{ resize:none; }

    /* Shift buttons */
    .shift-buttons{
      display:flex;
      gap:10px;
      margin-top:10px;
    }

    .shift-btn{
      flex:1;
      padding:14px;
      font-size:15px;
      font-weight:bold;
      border-radius:12px;
      border:2px solid #2563eb;
      background:white;
      color:#2563eb;
      cursor:pointer;
      transition:0.2s;
    }

    .shift-btn.active{
      background:#2563eb;
      color:white;
    }

    .shift-btn.submitted{
      background:#16a34a;
      border-color:#16a34a;
      color:white;
    }

    button.save-btn{
      margin-top:22px;
      width:100%;
      padding:16px;
      font-size:17px;
      font-weight:bold;
      border:none;
      border-radius:14px;
      background:#1d4ed8;
      color:white;
      cursor:pointer;
    }

    button.save-btn:disabled{
      opacity:0.6;
      cursor:not-allowed;
    }

    #statusBanner{
      margin-top:16px;
      padding:12px;
      border-radius:12px;
      font-weight:700;
      display:none;
    }

    .success{
      background:#dcfce7;
      color:#166534;
    }

    .error{
      background:#fee2e2;
      color:#991b1b;
    }

  </style>
</head>

<body>
<div class="card">

<h2>Production Report</h2>

<label>Date</label>
<input type="date" id="date">

<label>Production Line</label>
<select id="line">
  <option value="">-- Select Line --</option>
</select>

<label>Shift</label>
<div class="shift-buttons">
  <button type="button" class="shift-btn" data-shift="1">1st</button>
  <button type="button" class="shift-btn" data-shift="2">2nd</button>
  <button type="button" class="shift-btn" data-shift="3">3rd</button>
</div>

<input type="hidden" id="shift">

<label>Manpower</label>
<input type="number" id="manpower">

<label>Achieved</label>
<input type="number" id="achieved">

<label>Remark</label>
<textarea id="remark"></textarea>

<label>Recorder Name</label>
<input type="text" id="recorder">

<button class="save-btn" id="saveBtn" onclick="save()">Save</button>

<div id="statusBanner"></div>

</div>

<script>

document.getElementById("date").valueAsDate = new Date();

const shiftButtons = document.querySelectorAll(".shift-btn");

shiftButtons.forEach(btn=>{
  btn.addEventListener("click", ()=>{
    shiftButtons.forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById("shift").value = btn.dataset.shift;
    document.getElementById("manpower").focus();
  });
});

function showStatus(message, success){
  const banner = document.getElementById("statusBanner");
  banner.className = success ? "success" : "error";
  banner.innerText = message;
  banner.style.display = "block";
}

/* Fetch lines */
google.script.run.withSuccessHandler(function(data){
  const select = document.getElementById("line");
  data.forEach(l=>{
    const opt=document.createElement("option");
    opt.value=l.line;
    opt.text = l.line;
    select.appendChild(opt);
  });
}).getLineMaster();

function save(){

  const btn = document.getElementById("saveBtn");
  btn.disabled = true;

  const payload = {
    date: document.getElementById("date").value,
    line: document.getElementById("line").value,
    shift: document.getElementById("shift").value,
    manpower: document.getElementById("manpower").value,
    achieved: document.getElementById("achieved").value,
    remark: document.getElementById("remark").value,
    recorder: document.getElementById("recorder").value
  };

  if(!payload.line || !payload.shift || !payload.manpower || !payload.achieved){
    showStatus("All required fields must be filled.", false);
    btn.disabled = false;
    return;
  }

  google.script.run
    .withSuccessHandler(res=>{
      showStatus(res.message,res.ok);

      if(res.ok){
        shiftButtons.forEach(b=>{
          if(b.dataset.shift === payload.shift){
            b.classList.remove("active");
            b.classList.add("submitted");
          }
        });

        document.getElementById("manpower").value="";
        document.getElementById("achieved").value="";
        document.getElementById("remark").value="";
        document.getElementById("shift").value="";
      }

      btn.disabled=false;
    })
    .withFailureHandler(err=>{
      showStatus("Server Error: "+err.message,false);
      btn.disabled=false;
    })
    .submitData(payload);
}

</script>
</body>
</html>
